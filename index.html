<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>問い合わせ状況検索</title>
<style>
  :root{ --fg:#222; --bg:#fafafa; --muted:#666; --brand:#2e7d32; --border:#dcdcdc; }
  body{ font-family:"メイリオ","Hiragino Kaku Gothic ProN",sans-serif; background:var(--bg); color:var(--fg); margin:0; }
  .wrap{ max-width:960px; margin:0 auto; padding:24px; }
  h1{ font-size:28px; margin:0 0 16px; }
  .row{ display:flex; gap:12px; align-items:center; margin:10px 0; flex-wrap:wrap; }
  .row label{ min-width:140px; font-size:18px; }
  .row input,.row select{ font-size:18px; padding:10px; border:1px solid var(--border); border-radius:8px; flex:1; min-width:240px; }
  .btn{ font-size:20px; padding:12px 24px; border:none; border-radius:10px; background:var(--brand); color:#fff; cursor:pointer; }
  .btn:disabled{ background:#9e9e9e; cursor:not-allowed; }
  .note{ color:#c62828; margin:8px 0 0; min-height:1.4em; }
  table{ width:100%; border-collapse:collapse; margin-top:18px; background:#fff; }
  th,td{ border:1px solid var(--border); padding:12px; font-size:18px; text-align:left; }
  th{ background:#f2f2f2; }
  tr:nth-child(even){ background:#fcfcfc; }
  .pagination{ margin-top:14px; display:flex; gap:6px; justify-content:center; flex-wrap:wrap; }
  .page-btn{ font-size:18px; padding:8px 12px; border:1px solid var(--border); border-radius:8px; background:#fff; cursor:pointer; }
  .page-btn.active{ background:var(--brand); color:#fff; border-color:var(--brand); }
  .sr-only{ position:absolute; left:-10000px; }
</style>
</head>
<body>
<div class="wrap">
  <h1>問い合わせ状況検索</h1>

  <div class="row">
    <label for="monthSelect">対象年月（必須）：</label>
    <select id="monthSelect" aria-required="true">
      <option value="">-- 選択してください --</option>
    </select>
  </div>

  <div class="row">
    <label for="orderNo">受注番号：</label>
    <input id="orderNo" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="例）67890">
  </div>

  <div class="row">
    <label for="wedDate">挙式日：</label>
    <input id="wedDate" type="text" placeholder="例）9月12日">
  </div>

  <div class="row">
    <label for="groom">新郎姓：</label>
    <input id="groom" type="text" placeholder="例）山田">
  </div>

  <div class="row">
    <label for="bride">新婦姓：</label>
    <input id="bride" type="text" placeholder="例）佐藤">
  </div>

  <div class="row">
    <button id="searchBtn" class="btn">検索</button>
    <div id="msg" class="note" role="status" aria-live="polite"></div>
  </div>

  <div id="result"></div>
</div>

<script>
  // ★あなたのJSON公開先（GitHub Pages）
  const BASE_URL = "https://ko-umeda-coder.github.io/check-bc-np";

  const monthSelect = document.getElementById('monthSelect');
  const msg = document.getElementById('msg');
  const resultDiv = document.getElementById('result');
  const pageSize = 5;
  let all = [];     // 現在の月の全データ
  let view = [];    // 条件に合うデータ
  let page = 1;

  // 月一覧のロード
  async function loadMonths(){
    try{
      const res = await fetch(`${BASE_URL}/months.json?t=${Date.now()}`);
      if(!res.ok) throw new Error('months.jsonの取得に失敗');
      const months = await res.json();
      monthSelect.innerHTML = '<option value="">-- 選択してください --</option>';
      months.forEach(m=>{
        const opt=document.createElement('option');
        opt.value=m; opt.textContent=m;
        monthSelect.appendChild(opt);
      });
    }catch(e){
      msg.textContent = '対象年月の取得に失敗しました。時間をおいて再度お試しください。';
      console.error(e);
    }
  }

  // 月データ取得
  async function loadMonthData(monthJa){
    const m = monthJa.match(/^(\d{4})年(\d{1,2})月$/);
    const y = m[1], mm = ('0'+m[2]).slice(-2);
    const url = `${BASE_URL}/${y}-${mm}.json?t=${Date.now()}`;
    const res = await fetch(url);
    if(!res.ok) throw new Error('月データの取得に失敗');
    return await res.json();
  }

  // 検索
  async function onSearch(){
    const month = monthSelect.value;
    if(!month){ msg.textContent='対象年月を選択してください。'; return; }
    msg.textContent='';

    try{
      if(!all.length || all[0]?.['対象年月'] !== month){
        all = await loadMonthData(month);
      }
      const orderNo = document.getElementById('orderNo').value.trim();
      const wedDate = document.getElementById('wedDate').value.trim();
      const groom   = document.getElementById('groom').value.trim();
      const bride   = document.getElementById('bride').value.trim();

      view = all.filter(r =>
        (!orderNo || String(r['受注番号']||'').includes(orderNo)) &&
        (!wedDate || String(r['挙式日']||'').includes(wedDate))   &&
        (!groom   || String(r['新郎']||'').includes(groom))       &&
        (!bride   || String(r['新婦']||'').includes(bride))
      );

      page = 1;
      render();
    }catch(e){
      msg.textContent = '検索時にエラーが発生しました。';
      console.error(e);
    }
  }

  // 描画
  function render(){
    if(view.length === 0){
      resultDiv.innerHTML = '<p>該当データがありません。</p>';
      return;
    }
    const start = (page-1)*pageSize;
    const slice = view.slice(start, start+pageSize);

    let html = '<table><thead><tr>'+
      '<th>受注番号</th><th>挙式日</th><th>新郎</th><th>新婦</th><th>バックカラー</th><th>ネームプレート</th>'+
      '</tr></thead><tbody>';

    slice.forEach(r=>{
      const bk = r['BK'] || '問い合わせ中';
      const plate = r['ネームプレート'] || '問い合わせ中です。';
      html += `<tr>
        <td>${safe(r['受注番号'])}</td>
        <td>${safe(r['挙式日'])}</td>
        <td>${safe(r['新郎'])}</td>
        <td>${safe(r['新婦'])}</td>
        <td>${safe(bk)}</td>
        <td>${safe(plate)}</td>
      </tr>`;
    });
    html += '</tbody></table>';

    // ページネーション
    const totalPages = Math.ceil(view.length/pageSize);
    if(totalPages>1){
      html += '<div class="pagination">';
      for(let i=1;i<=totalPages;i++){
        html += `<button class="page-btn ${i===page?'active':''}" onclick="go(${i})" aria-label="ページ ${i}">${i}</button>`;
      }
      html += '</div>';
    }
    resultDiv.innerHTML = html;
  }
  function go(p){ page=p; render(); }
  function safe(s){ return (s==null)?'':String(s); }

  document.getElementById('searchBtn').addEventListener('click', onSearch);
  window.addEventListener('DOMContentLoaded', loadMonths);
</script>
</body>
</html>
